阿涛, [2025/11/28 18:46]
<script>
/* ========================
   配置（如需改域名请设置 API_BASE）
   ======================== */
const API_BASE = ""; // 同域为空，或 "https://api.yourdomain.com"

/* ========== 数据 ========== */
const BANNERS = [
  {img:"/IMG_1683.png", text:"首充翻倍 · 日常返水"},
  {img:"https://via.placeholder.com/720x320/aa2200/fff?text=麻将胡了", text:"新游上线：《麻将胡了》"},
  {img:"https://via.placeholder.com/720x320/bb4400/fff?text=黄金时段", text:"黄金时段送大礼包"}
];

const GAMES = [
  {id:1,title:"Gates of Olympus", tag:"老虎机", img:"/assets/gates.jpg", url:"/games/gates.html"},
  {id:2,title:"麻将胡了 H5", tag:"棋牌", img:"/assets/mahjong.jpg", url:"/games/mahjong/index.html"},
  {id:3,title:"捕鱼达人", tag:"捕鱼", img:"/assets/fish.jpg", url:"/games/fish/index.html"}
];

/* ========== DOM 元素 ========== */
const bannerEl = document.getElementById("banner");
const dotsEl = document.getElementById("banner-dots");
const gamesEl = document.getElementById("games");
const balanceEl = document.getElementById("balance");
const balanceNoteEl = document.getElementById("balance-note");
const modalBackdrop = document.getElementById("modal-backdrop");
const modalTitle = document.getElementById("modal-title");
const modalBody = document.getElementById("modal-body");
const modalClose = document.getElementById("modal-close");
const openSettingsBtn = document.getElementById("open-settings");
const rechargeBtn = document.getElementById("recharge-btn");
const withdrawBtn = document.getElementById("withdraw-btn");
const navWallet = document.getElementById("nav-wallet");

/* ========== 状态 ========== */
let activeBanner = 0;
let localBalance = 0.00; // 本地平衡缓存
let pendingOperations = {}; // { opId: {type, amount, revertBalance} }

/* ========== 通用帮助函数 ========== */
function safeImg(src, fallback){
  const img = document.createElement('img');
  img.src = src;
  img.onerror = ()=>{ img.src = fallback; };
  return img;
}
function showModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalBackdrop.style.display = "flex";
}
function hideModal(){ modalBackdrop.style.display = "none"; }
modalClose.onclick = hideModal;
modalBackdrop.onclick = (e)=>{ if(e.target===modalBackdrop) hideModal(); };

/* ========== Banner 轮播 ========== */
function renderBanner(){
  bannerEl.innerHTML = "";
  const b = BANNERS[activeBanner] || BANNERS[0];
  const img = document.createElement("img");
  img.src = b.img;
  img.alt = b.text || "";
  img.onerror = ()=>{ img.src = "https://via.placeholder.com/720x320/333/fff?text=占位"; };
  bannerEl.appendChild(img);

  const txt = document.createElement("div");
  txt.className = "text";
  txt.textContent = b.text || "";
  bannerEl.appendChild(txt);

  // dots
  dotsEl.innerHTML = "";
  BANNERS.forEach((_,i)=>{
    const d = document.createElement("button");
    d.style.width="8px"; d.style.height="8px"; d.style.borderRadius="999px"; d.style.border=0;
    d.style.background = i===activeBanner ? "var(--accent)" : "rgba(255,255,255,0.12)";
    d.style.margin="0 4px";
    d.onclick = ()=>{ activeBanner=i; renderBanner(); };
    dotsEl.appendChild(d);
  });
}
renderBanner();
setInterval(()=>{ activeBanner = (activeBanner+1)%BANNERS.length; renderBanner(); }, 4800);

/* ========== 渲染游戏卡片（带缺图回退 & 分类支持） ========== */
function renderGames(filterCat){
  gamesEl.innerHTML = "";
  const list = GAMES.filter(g => !filterCat  g.tag.includes(filterCat)  filterCat === 'all');
  list.forEach(g=>{
    const card = document.createElement("div");
    card.className = "game";
    // 图片（支持仓库内资源或远程）
    const imgEl = document.createElement("img");
    imgEl.src = g.img;
    imgEl.alt = g.title;
    imgEl.onerror = ()=>{ imgEl.src = "https://via.placeholder.com/360x200/222/fff?text=无图"; };
    card.appendChild(imgEl);

    const info = document.createElement("div");
    info.className = "info";
    info.textContent = g.title;
    card.appendChild(info);

    const btn = document.createElement("button");
    btn.className = "play";
    btn.textContent = "进入";
    btn.onclick = (e)=>{ e.stopPropagation(); openGame(g); };
    card.appendChild(btn);

    card.

阿涛, [2025/11/28 18:46]
onclick = ()=> openGame(g);

    gamesEl.appendChild(card);
  });
}
renderGames();

/* ========== 打开游戏（先校验 initData 再打开） ========== */
async function openGame(g){
  try{
    // 首先调用后端 verifyInitData（如果后端返回 ok 才打开）—— 安全校验
    const res = await fetch((API_BASE || "") + "/api/verifyInitData", { method: "POST", credentials: "include" });
    if(!res.ok){
      const j = await res.json().catch(()=>({message:res.statusText}));
      alert("校验失败：" + (j.message || "请在 BotFather 配置 Direct Link 与 BOT_TOKEN"));
      return;
    }
    // 可选：记录点击埋点
    navigator.sendBeacon && navigator.sendBeacon((API_BASE || "") + "/api/track", JSON.stringify({ action: "game_click", gameId: g.id }));

    // 打开游戏：优先在新 tab 打开
    window.open(g.url, "_blank");
  }catch(err){
    console.error("openGame error", err);
    alert("打开游戏失败，请稍后重试");
  }
}

/* ========== 余额读取（后端接口） ========== */
async function fetchBalance(){
  try{
    const res = await fetch((API_BASE || "") + "/api/balance", {method:"GET", credentials:"include"});
    if(!res.ok) throw new Error("balance non-200");
    const data = await res.json();
    localBalance = parseFloat(data.balance  0)  0;
    updateBalanceUI();
  }catch(err){
    console.error("fetchBalance err", err);
    balanceEl.textContent = "¥0.00";
    balanceNoteEl.textContent = "更新失败";
  }
}
function updateBalanceUI(){
  // 计算 pending 合计（展示为“待确认”）
  const pendingSum = Object.values(pendingOperations).reduce((s,o)=> o.type==='recharge'? s+o.amount : s-o.amount, 0);
  const display = localBalance + pendingSum;
  balanceEl.textContent = "¥" + display.toFixed(2);
  const now = new Date().toLocaleTimeString();
  balanceNoteEl.textContent = "上次更新：" + now + (pendingSum!==0 ? " · 含待确认变动" : "");
}

/* ========== 乐观充值（先 UI 更新，再确认） ========== */
rechargeBtn.onclick = ()=> {
  const html = `
    <div>
      <div style="font-size:13px;color:var(--muted)">请输入充值金额</div>
      <div class="form-row"><input id="recharge-amt" class="input" placeholder="例如 100" type="number" min="1"/></div>
      <div style="margin-top:10px;text-align:right"><button id="do-recharge" class="btn btn-primary">创建充值订单</button></div>
    </div>
  `;
  showModal("充值", html);
  document.getElementById("do-recharge").onclick = async ()=>{
    const amt = parseFloat(document.getElementById("recharge-amt").value);
    if(!amt || amt<=0){ alert("请输入正确金额"); return; }

    // 乐观更新：生成临时 op id 并记录 revert 值
    const opId = "op-" + Math.random().toString(36).slice(2,9);
    pendingOperations[opId] = { type:"recharge", amount: amt, createdAt: Date.now() };
    updateBalanceUI();
    hideModal();

    try{
      const res = await fetch((API_BASE || "") + "/api/recharge", {
        method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
        body: JSON.stringify({ amount: amt })
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok){
        // 回滚
        delete pendingOperations[opId];
        updateBalanceUI();
        alert("充值失败：" + (j.message || res.status));
        return;
      }
      // 后端返回成功：把 pending 转正式（我们这里把本地余额累加并移除 pending）
      localBalance += amt;
      delete pendingOperations[opId];
      updateBalanceUI();
      alert("充值订单已创建，订单号：" + (j.orderId || "未返回"));
    }catch(e){
      // 回滚
      delete pendingOperations[opId];
      updateBalanceUI();
      alert("充值请求失败");
      console.error(e);
    }
  };
};

/* ========== 乐观提现（先 UI 扣减，再确认） ========== */
withdrawBtn.onclick = ()=>{
  const html = `
    <div>
      <div style="font-size:13px;color:var(--muted)">请输入提现金额</div>
      <div class="form-row"><input id="withdraw-amt" class="input" placeholder="例如 200" type="number" min="1"/></div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">注意：提现需审核，余额会暂时扣除。</div>
      <div style="margin-top:10px;text-align:right"><button id="do-withdraw" class="btn btn-primary">申请提现</button></div>
    </div>
  `;
  showModal("提现", html);
  document.getElementById("do-withdraw").onclick = async ()=>{
    const amt = parseFloat(document.getElementById("withdraw-amt").value);

阿涛, [2025/11/28 18:46]
if(!amt || amt<=0){ alert("请输入正确金额"); return; }
    if(amt > (localBalance + Object.values(pendingOperations).reduce((s,o)=> o.type==='recharge'? s+o.amount : s-o.amount, 0))){
      alert("余额不足");
      return;
    }

    const opId = "op-" + Math.random().toString(36).slice(2,9);
    pendingOperations[opId] = { type:"withdraw", amount: amt, createdAt: Date.now() };
    updateBalanceUI();
    hideModal();

    try{
      const res = await fetch((API_BASE || "") + "/api/withdraw", {
        method:"POST", headers:{"Content-Type":"application/json"}, credentials:"include",
        body: JSON.stringify({ amount: amt })
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok){
        delete pendingOperations[opId];
        updateBalanceUI();
        alert("提现失败：" + (j.message || res.status));
        return;
      }
      // 成功：从本地余额扣除并移除 pending
      localBalance -= amt;
      delete pendingOperations[opId];
      updateBalanceUI();
      alert("提现申请已提交，流水号：" + (j.withdrawId || "未返回"));
    }catch(e){
      delete pendingOperations[opId];
      updateBalanceUI();
      alert("提现请求失败");
      console.error(e);
    }
  };
};

/* ========== 设置（系统诊断） ========== */
openSettingsBtn.onclick = async ()=>{
  showModal("设置 · 系统诊断", `<div style="font-size:13px;color:var(--muted)">正在检测...</div>`);
  try{
    const res = await fetch((API_BASE || "") + "/api/verifyInitData", { method:"POST", credentials:"include" });
    const j = await res.json().catch(()=>({}));
    if(!res.ok){
      modalBody.innerHTML = <div style="font-size:13px;color:#ff7b7b">initData 验证失败：${j.message || res.status}</div>;
      return;
    }
    modalBody.innerHTML = `<div style="font-size:13px;color:#7be495">initData 校验通过</div>
      <div style="margin-top:8px;font-size:13px;color:var(--muted)"><pre style="white-space:pre-wrap">${JSON.stringify(j, null, 2)}</pre></div>
      <div style="text-align:right;margin-top:8px"><button id="close-ok" class="btn btn-ghost">关闭</button></div>`;
    document.getElementById("close-ok").onclick = hideModal;
  }catch(e){
    modalBody.innerHTML = <div style="font-size:13px;color:#ff7b7b">检测失败</div>;
    console.error(e);
  }
};

/* ========== 绑定分类点击（筛选） ========== */
document.getElementById("categories").addEventListener("click", (e)=>{
  const card = e.target.closest(".cat");
  if(!card) return;
  const cat = card.getAttribute("data-cat");
  if(!cat) return;
  if(cat === 'hot') renderGames('all');
  else if(cat === 'slots') renderGames('老虎机');
  else if(cat === 'mahjong') renderGames('棋牌');
  else if(cat === 'live') renderGames('真人');
  else if(cat === 'lottery') renderGames('彩票');
  else if(cat === 'sports') renderGames('体育');
});

/* ========== Telegram WebApp 与自动刷新 ========== */
if(window.Telegram && Telegram.WebApp){
  Telegram.WebApp.ready();
  try{
    const initData = Telegram.WebApp.initData || null;
    // 如果你想要把 initData 发送到后端作为登录态校验，可在这里做
    // fetch((API_BASE||"") + "/api/verifyInitData", {method:"POST", body: JSON.stringify({initData}), headers:{"Content-Type":"application/json"}});
  }catch(e){}
  document.getElementById("tg-status") && (document.getElementById("tg-status").textContent = "Telegram: 已就绪");
}

/* ========== 定期刷新余额 & 首次加载 ========== */
fetchBalance();
setInterval(fetchBalance, 20000); // 每20秒刷新一次

/* ========== 手动进入钱包页（示例） ========== */
navWallet && navWallet.addEventListener("click", ()=> {
  // 你可以跳转到钱包页面或弹窗展示更详细的流水
  showModal("钱包明细", `<div style="font-size:13px;color:var(--muted)">余额：${balanceEl.textContent}<br/>（示例）</div>`);
});
</script>
